<!doctype html>
<html>
<head>
  <title>bluetooth</title>
  <style>
    table.controls {
      width: 100%;
    }

    table.controls td {
      width: 33%;
    }

    table.controls td button {
      font-size: 34pt;
      width: 100%;
      }
        </style>
</head>
<body>

<div>
  <button id=connect>Not connected</button>
  <table class=controls>
    <tr>
      <td></td>
      <td><button class=write data-value="forward">‚¨ÜÔ∏è</button></td>
      <td></td>
    </tr>
    <tr>
      <td><button class=write data-value="left">‚¨ÖÔ∏è</button></td>
      <td><button class=write data-value="stop">üõë</button></td>
      <td><button class=write data-value="right">‚û°</button></td>
    </tr>
    <tr>
      <td></td>
      <td><button class=write data-value="back">‚¨áÔ∏è</button></td>
      <td></td>
    </tr>
  </table>
  <button id=stop>Stop</button>
</div>

<script>

const serviceUuid = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const writeCharacteristicUuid = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";

let writeDescriptor;
let characteristic

document.getElementById('connect').addEventListener('click', async e => {
  
  try {
    console.log('requesting any Bluetooth Device...');
    const device = await navigator.bluetooth.requestDevice({
     // filters: [...] <- Prefer filters to save energy & show relevant devices.
        acceptAllDevices: true, optionalServices: [serviceUuid]});

    console.log('Connecting to GATT Server...');
    const server = await device.gatt.connect();

    console.log('Getting Service...');
    const service = await server.getPrimaryService(serviceUuid);

    console.log('Getting Characteristic...');
    characteristic = await service.getCharacteristic(writeCharacteristicUuid);
    
    document.querySelector('#connect').disabled = !characteristic.properties.write;
    e.target.textContent = 'connected';
  } catch (e) {
    console.error(e);
  }
})
 
const buttons = document.getElementsByClassName('write')
Array.from(buttons).forEach(element => element.addEventListener('click', write(e.target.dataset.value)))


async function write(value) {
  let encoder = new TextEncoder('utf-8');
  await characteristic.writeValue(encoder.encode(value));
  console.log(`Wrote value`, value, encoder.encode(value));
}

</script>
</html>
