<!doctype html>
<html>
<head>
  <title>bluetooth</title>
  <style>
    table.controls {
      width: 100%;
    }

    table.controls td {
      width: 33%;
    }

    table.controls td button {
      font-size: 34pt;
      width: 100%;
      }
        </style>
</head>
<body>

<div>
  <button id=connect>connect</button>
  <table class=controls>
    <tr>
      <td></td>
      <td><button class=write data-value="forward">‚¨ÜÔ∏è</button></td>
      <td></td>
    </tr>
    <tr>
      <td><button class=write data-value="left">‚¨ÖÔ∏è</button></td>
      <td><button class=write data-value="stop">üõë</button></td>
      <td><button class=write data-value="right">‚û°</button></td>
    </tr>
    <tr>
      <td></td>
      <td><button class=write data-value="back">‚¨áÔ∏è</button></td>
      <td></td>
    </tr>
  </table>
</div>

<script>

const serviceUuid = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const writeCharacteristicUuid = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";

let writeDescriptor;
let characteristic
let device
let encoder = new TextEncoder('utf-8');


document.getElementById('connect').addEventListener('click', async e => {

  if (device?.gatt?.connected) {
    await device.gatt.disconnect()
    e.target.textContent = 'connect';
  } else {
    try {
      console.log('requesting any Bluetooth Device...');
      device = await navigator.bluetooth.requestDevice({
        //filters: 
        //[ 
        //{ services: [ serviceUuid ] }
        //]
        acceptAllDevices: true
      });
        
      

      console.log('Connecting to GATT Server...');
      const server = await device.gatt.connect();

      console.log('Getting Service...');
      const service = await server.getPrimaryService(serviceUuid);

      console.log('Getting Characteristic...');
      characteristic = await service.getCharacteristic(writeCharacteristicUuid);
      
      e.target.textContent = 'connected';
    } catch (e) {
      console.error(e);
    }
  }
})
 
const buttons = document.getElementsByClassName('write')
Array.from(buttons).forEach(element => element.addEventListener('click', e => write(e.target.dataset.value)))

function handleDisconnect () {
  document.getElementById('connect').textContent = 'connect'
  alert('bluetooth disconnected')
}

async function write(value) {
  if (value == "stop") {
    gattQueue = []; // if it's stop, disregard everything else
  }
  gattQueue.push( value );
}

//also handle keys

//event listener
window.addEventListener("keydown", onKeyDown, false);
window.addEventListener("keyup", onKeyUp, false);

function onKeyDown(event) {
  var keyCode = event.keyCode;
  switch (keyCode) {
    case 68: //d
      write('right')
      break;
    case 83: //s
      write('back')
      break;
    case 65: //a
      write('left')
      break;
    case 87: //w
      write('forward')
      break;
  }
}

function onKeyUp(event) {
  var keyCode = event.keyCode;

  switch (keyCode) {
    case 68: //d
      write('stop')
      break;
    case 83: //s
      write('stop')
      break;
    case 65: //a
      write('stop')
      break;
    case 87: //w
      write('stop')
      break;
  }
}

const gattQueue = []

setInterval( async () => {

  try {
    if (!device?.gatt?.connected) {
      return
    } 

    const nextValue = gattQueue.pop();

    if (next) {
      await characteristic.writeValue(encoder.encode(value))
      console.log(`Wrote value`, value, encoder.encode(value));
    }

  } catch (e) {
    console.error('error', e)
    //alert('bluetooth error, try to reconnect')
  }
}, 50);

</script>
</html>
